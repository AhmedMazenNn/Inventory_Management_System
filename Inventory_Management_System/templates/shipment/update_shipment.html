{% extends 'base/base.html' %}

{% load crispy_forms_tags %}
{% load static %}

{% block title %} Update Shipment {% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Update Shipment</h2>
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show w-50" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        {{ shipment_form|crispy }}

        <h2>Update Products</h2>
        <div id="formset-management">
            {{ formset.management_form }}
        </div>

        <div id="shipment-items">
            {% for form in formset %}
            <div class="shipment-item-form">
                {{ form|crispy }}
                <button type="button" class="btn btn-danger btn-sm remove-product">Remove</button>
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add-product" class="btn btn-success">Add Product</button>
        <button type="submit" class="btn btn-primary">Save Shipment</button>
    </form>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let formsetPrefix = "{{ formset.prefix }}";
        let formIdx = parseInt("{{ formset.total_form_count }}");

        function addProduct() {
            let emptyFormHtml = `{{ formset.empty_form|crispy|escapejs }}`.replace(/__prefix__/g, formIdx);
            let newForm = document.createElement("div");
            newForm.classList.add("shipment-item-form");
            newForm.innerHTML = emptyFormHtml + `<button type="button" class="btn btn-danger btn-sm remove-product">Remove</button>`;
            document.getElementById("shipment-items").appendChild(newForm);
            formIdx++;
            document.querySelector(`#id_${formsetPrefix}-TOTAL_FORMS`).value = formIdx;
        }

        function removeProduct(event) {
            if (event.target.classList.contains("remove-product")) {
                event.target.closest(".shipment-item-form").remove();
                formIdx--;
                document.querySelector(`#id_${formsetPrefix}-TOTAL_FORMS`).value = formIdx;
            }
        }

        document.getElementById("add-product").addEventListener("click", addProduct);
        document.getElementById("shipment-items").addEventListener("click", removeProduct);
    });
</script>
{% endblock %}